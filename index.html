<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar Events</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Upcoming Calendar Events</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1">A simple client-side Google Calendar API integration.</p>
            </div>
            <div class="flex space-x-2 mt-4 md:mt-0">
                <button id="authorize_button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Authorize
                </button>
                <button id="signout_button" class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Sign Out
                </button>
            </div>
        </div>

        <!-- Instructions Section -->
        <div id="instructions" class="mb-6 p-4 bg-yellow-100 dark:bg-gray-700 border-l-4 border-yellow-500 dark:border-yellow-400 rounded-r-lg">
            <h3 class="font-bold text-yellow-800 dark:text-yellow-300">Action Required</h3>
            <p class="text-sm text-yellow-700 dark:text-yellow-200 mt-1">
                To use this, you must get an <strong>API Key</strong> and <strong>OAuth 2.0 Client ID</strong> from the <a href="https://console.cloud.google.com/" target="_blank" rel="noopener noreferrer" class="underline hover:text-yellow-500">Google Cloud Console</a>.
                Make sure to enable the "Google Calendar API" and configure your OAuth consent screen with the correct authorized JavaScript origins. Then, paste your credentials into the script below.
            </p>
        </div>
        
        <!-- Events list container -->
        <div id="events_container" class="space-y-4">
            <p id="status_message" class="text-center text-gray-500 dark:text-gray-400 py-8">Please authorize to see your upcoming events.</p>
        </div>
    </div>

    <!-- Google API Client and Identity Services Scripts -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script type="text/javascript">
        /*
         * =========================================================================
         * IMPORTANT: PASTE YOUR GOOGLE CLOUD CREDENTIALS HERE
         * =========================================================================
         */
        const API_KEY = 'AIzaSyCUhd0JfEzWlolkgAjPvfd6Fsyl60XtEY0'; 
        const CLIENT_ID = '703348367691-fto8h5ngp2hm5qn5fkbfhtsh7re3pcub.apps.googleusercontent.com';

        /*
         * =========================================================================
         * CONFIGURATION - You shouldn't need to change these
         * =========================================================================
         */
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const eventsContainer = document.getElementById('events_container');
        const statusMessage = document.getElementById('status_message');
        const instructions = document.getElementById('instructions');

        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;

        /**
         * Callback after api.js is loaded.
         */
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        /**
         * Callback after the API client is loaded. Loads the
         * discovery doc to initialize the API.
         */
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        /**
         * Callback after Google Identity Services are loaded.
         */
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        /**
         * Enables user interaction after all libraries are loaded.
         */
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                authorizeButton.disabled = false;
            }
        }

        /**
         * Sign in the user upon button click.
         */
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                updateUIForAuth();
                await listUpcomingEvents();
            };

            if (gapi.client.getToken() === null) {
                // Prompt the user to select a Google Account and ask for consent to share their data
                // when establishing a new session.
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                // Skip display of account chooser and consent dialog for an existing session.
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        /**
         * Sign out the user upon button click.
         */
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateUIForSignout();
            }
        }

        /**
         * Updates the UI to reflect that the user is authorized.
         */
        function updateUIForAuth() {
            authorizeButton.classList.add('hidden');
            signoutButton.classList.remove('hidden');
            instructions.classList.add('hidden');
            eventsContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-8">Loading events...</p>';
        }

        /**
         * Updates the UI to reflect that the user is signed out.
         */
        function updateUIForSignout() {
            authorizeButton.classList.remove('hidden');
            signoutButton.classList.add('hidden');
            instructions.classList.remove('hidden');
            eventsContainer.innerHTML = '<p id="status_message" class="text-center text-gray-500 dark:text-gray-400 py-8">Please authorize to see your upcoming events.</p>';
        }


        /**
         * Print the summary and start datetime/date of the next 10 events in the
         * user's primary calendar. If no events are found, print a message.
         */
        async function listUpcomingEvents() {
            let response;
            try {
                const request = {
                    'calendarId': 'primary',
                    'timeMin': (new Date()).toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'maxResults': 10,
                    'orderBy': 'startTime',
                };
                response = await gapi.client.calendar.events.list(request);
            } catch (err) {
                eventsContainer.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 py-8">Error: ${err.message}</p>`;
                return;
            }

            const events = response.result.items;
            if (!events || events.length == 0) {
                eventsContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-8">No upcoming events found.</p>';
                return;
            }

            // Clear previous content
            eventsContainer.innerHTML = '';
            
            // Flatten to string to display
            events.forEach(event => {
                const when = event.start.dateTime;
                const eventElement = document.createElement('div');
                eventElement.className = "p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 flex items-start space-x-4";
                
                const date = new Date(when || event.start.date);
                
                const dateBlock = `
                    <div class="flex-shrink-0 text-center bg-blue-100 dark:bg-blue-900/50 p-3 rounded-md w-20">
                        <p class="text-blue-600 dark:text-blue-300 font-bold text-sm">${date.toLocaleString('default', { month: 'short' }).toUpperCase()}</p>
                        <p class="text-gray-900 dark:text-white font-extrabold text-2xl">${date.getDate()}</p>
                    </div>
                `;

                const eventDetails = `
                    <div>
                        <h3 class="font-semibold text-lg text-gray-900 dark:text-white">${event.summary}</h3>
                        <p class="text-gray-500 dark:text-gray-400 text-sm">${formatEventTime(event.start, event.end)}</p>
                    </div>
                `;

                eventElement.innerHTML = dateBlock + eventDetails;
                eventsContainer.appendChild(eventElement);
            });
        }
        
        /**
         * Helper function to format the event time range.
         */
        function formatEventTime(start, end) {
            const startDate = new Date(start.dateTime || start.date);
            const endDate = new Date(end.dateTime || end.date);
            
            const options = {
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            };

            // Handle all-day events
            if (start.date) {
                // Check if it's a multi-day event
                if (endDate.getTime() > startDate.getTime() + 86400000) { // More than 1 day
                     return `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
                }
                return 'All day';
            }
            
            const startTimeString = startDate.toLocaleString('en-US', options);
            const endTimeString = endDate.toLocaleString('en-US', options);
            
            return `${startTimeString} - ${endTimeString}`;
        }

    </script>
</body>
</html>
