<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar & Drive Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .spinner {
            border-color: #3498db;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Cloud Sync</h1>
            <p class="text-lg text-gray-600 mt-2">Sync your notes with Google Drive and events with Google Calendar.</p>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="bg-white p-6 rounded-2xl shadow-lg">
            <!-- Auth Section -->
            <div id="auth-section" class="text-center">
                <h2 class="text-2xl font-semibold mb-4">Get Started</h2>
                <p class="mb-6 text-gray-600">Please sign in to connect your Google Account.</p>
                <div id="auth-spinner" class="flex justify-center items-center h-16 hidden">
                    <div class="spinner w-8 h-8 rounded-full border-4"></div>
                </div>
                <div id="auth-buttons">
                    <button id="google-connect-btn"
                        class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center mx-auto">
                        <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px"
                            height="48px">
                            <path fill="#FFC107"
                                d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" />
                            <path fill="#FF3D00"
                                d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" />
                            <path fill="#4CAF50"
                                d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" />
t                            <path fill="#1976D2"
                                d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.986,36.686,44,31.139,44,24C44,22.659,43.862,21.35,43.611,20.083z" />
                        </svg>
                        Connect Google Account
                    </button>
                    <button id="google-disconnect-btn"
                        class="hidden bg-red-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-red-600 transition-all duration-300 ease-in-out transform hover:scale-105 mt-4">
                        Disconnect Google Account
                    </button>
                </div>
            </div>

            <!-- Logged In Content -->
            <div id="logged-in-content" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <p>Welcome, <span id="user-name" class="font-semibold"></span>!</p>
                    <p id="user-id" class="text-sm text-gray-500"></p>
                </div>

                <!-- Tabs -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="drive-tab-btn"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-blue-500 text-blue-600">Google
                            Drive</button>
                        <button id="calendar-tab-btn"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Google
                            Calendar</button>
                    </nav>
                </div>

                <!-- Google Drive Tab -->
                <div id="drive-tab">
                    <div class="mt-6">
                        <textarea id="note-content" rows="6"
                            class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                            placeholder="Write a note to save to Google Drive..."></textarea>
                        <button id="save-note-btn"
                            class="mt-4 bg-green-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-600 transition-colors">Save
                            Note</button>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-4">Saved Notes</h3>
                        <div id="notes-list" class="space-y-3">
                             <!-- Notes will be loaded here -->
                        </div>
                         <div id="drive-spinner" class="flex justify-center items-center h-20 hidden">
                            <div class="spinner w-8 h-8 rounded-full border-4"></div>
                        </div>
                    </div>
                </div>

                <!-- Google Calendar Tab -->
                <div id="calendar-tab" class="hidden">
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold mb-2">Create New Event</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="event-title" placeholder="Event Title"
                                class="p-3 border border-gray-300 rounded-lg">
                            <input type="datetime-local" id="event-start-time"
                                class="p-3 border border-gray-300 rounded-lg">
                        </div>
                        <button id="create-event-btn"
                            class="mt-4 bg-purple-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-purple-600 transition-colors">Create
                            Event</button>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-4">Upcoming Events</h3>
                        <ul id="events-list" class="space-y-3">
                           <!-- Events will be loaded here -->
                        </ul>
                        <div id="calendar-spinner" class="flex justify-center items-center h-20 hidden">
                            <div class="spinner w-8 h-8 rounded-full border-4"></div>
                        </div>
                    </div>
                </div>
            </div>
             <!-- Message Modal -->
            <div id="message-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                    <p id="message-text" class="text-lg"></p>
                    <button id="message-close-btn"
                        class="mt-4 bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600">OK</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // --- DO NOT EDIT ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "test", authDomain: "test.firebaseapp.com", projectId: "test" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;
        // --- DO NOT EDIT ---

        let app, auth, db;
        let userId = null;

        // --- Google API Config ---
        // IMPORTANT: You must replace these placeholder values with your own credentials
        // from the Google Cloud Console.
        // 1. Go to https://console.cloud.google.com/
        // 2. Create a new project.
        // 3. Go to "APIs & Services" > "Credentials".
        // 4. Create an "API key" and paste it below.
        // 5. Create an "OAuth 2.0 Client ID" (for Web application), add your authorized JavaScript origins, and paste the Client ID below.
        // 6. Go to "APIs & Services" > "Library" and enable "Google Drive API" and "Google Calendar API".
        const GAPI_CLIENT_ID = '703348367691-fto8h5ngp2hm5qn5fkbfhtsh7re3pcub.apps.googleusercontent.com';
        const GAPI_API_KEY = 'AIzaSyCUhd0JfEzWlolkgAjPvfd6Fsyl60XtEY0';
        const GAPI_SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/calendar.events';
        const GAPI_DISCOVERY_DOCS = [
            "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
            "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"
        ];

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let googleToken = null;

        // DOM Elements
        const mainContent = document.getElementById('main-content');
        const authSection = document.getElementById('auth-section');
        const loggedInContent = document.getElementById('logged-in-content');
        const authSpinner = document.getElementById('auth-spinner');
        const authButtons = document.getElementById('auth-buttons');

        const connectBtn = document.getElementById('google-connect-btn');
        const disconnectBtn = document.getElementById('google-disconnect-btn');

        const userNameEl = document.getElementById('user-name');
        const userIdEl = document.getElementById('user-id');
        
        const driveTabBtn = document.getElementById('drive-tab-btn');
        const calendarTabBtn = document.getElementById('calendar-tab-btn');
        const driveTab = document.getElementById('drive-tab');
        const calendarTab = document.getElementById('calendar-tab');
        
        const noteContentEl = document.getElementById('note-content');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const notesListEl = document.getElementById('notes-list');
        const driveSpinner = document.getElementById('drive-spinner');
        
        const eventTitleEl = document.getElementById('event-title');
        const eventStartTimeEl = document.getElementById('event-start-time');
        const createEventBtn = document.getElementById('create-event-btn');
        const eventsListEl = document.getElementById('events-list');
        const calendarSpinner = document.getElementById('calendar-spinner');

        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const messageCloseBtn = document.getElementById('message-close-btn');

        // --- Initialization ---
        
        function showMessage(msg) {
            messageText.textContent = msg;
            messageModal.classList.remove('hidden');
        }
        
        messageCloseBtn.addEventListener('click', () => messageModal.classList.add('hidden'));
        
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuthObserver();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Could not connect to services. Please refresh the page.");
            }
        }
        
        async function setupAuthObserver() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdEl.textContent = `User ID: ${userId}`;
                    authSpinner.classList.add('hidden');
                    authButtons.classList.remove('hidden');
                    await loadTokenFromFirestore();
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch(error) {
                         console.error("Anonymous sign-in failed:", error);
                         showMessage("Authentication failed. Please try again later.");
                    }
                }
            });
        }
        
        // --- UI Control ---

        function showAuthView() {
            authSection.classList.remove('hidden');
            loggedInContent.classList.add('hidden');
        }

        function showLoggedInView(name) {
            authSection.classList.add('hidden');
            loggedInContent.classList.remove('hidden');
            connectBtn.classList.add('hidden');
            disconnectBtn.classList.remove('hidden');
            userNameEl.textContent = name;
        }
        
        function showDisconnectedView() {
            connectBtn.classList.remove('hidden');
            disconnectBtn.classList.add('hidden');
            showAuthView();
        }

        driveTabBtn.addEventListener('click', () => {
             driveTab.classList.remove('hidden');
             calendarTab.classList.add('hidden');
             driveTabBtn.classList.add('border-blue-500', 'text-blue-600');
             driveTabBtn.classList.remove('border-transparent', 'text-gray-500');
             calendarTabBtn.classList.remove('border-blue-500', 'text-blue-600');
             calendarTabBtn.classList.add('border-transparent', 'text-gray-500');
        });

        calendarTabBtn.addEventListener('click', () => {
             driveTab.classList.add('hidden');
             calendarTab.classList.remove('hidden');
             calendarTabBtn.classList.add('border-blue-500', 'text-blue-600');
             calendarTabBtn.classList.remove('border-transparent', 'text-gray-500');
             driveTabBtn.classList.remove('border-blue-500', 'text-blue-600');
             driveTabBtn.classList.add('border-transparent', 'text-gray-500');
        });


        // --- Google API Handlers ---
        
        function loadGoogleAPIs() {
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.async = true;
            gapiScript.defer = true;
            gapiScript.onload = () => {
                gapi.load('client', initializeGapiClient);
            };
            document.head.appendChild(gapiScript);

            const gisScript = document.createElement('script');
            gisScript.src = 'https://accounts.google.com/gsi/client';
            gisScript.async = true;
            gisScript.defer = true;
            gisScript.onload = () => {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GAPI_CLIENT_ID,
                    scope: GAPI_SCOPES,
                    callback: '', // Will be set dynamically
                });
                gisInited = true;
                maybeEnableButtons();
            };
            document.head.appendChild(gisScript);
        }

        async function initializeGapiClient() {
            // FIX: Check for placeholder API key before initializing
            if (GAPI_API_KEY === 'YOUR_GOOGLE_API_KEY') {
                showMessage("API Key is missing. Please replace 'YOUR_GOOGLE_API_KEY' with your actual key.");
                return;
            }
            try {
                await gapi.client.init({
                    apiKey: GAPI_API_KEY,
                    discoveryDocs: GAPI_DISCOVERY_DOCS,
                });
                gapiInited = true;
                maybeEnableButtons();
            } catch (error) {
                console.error("GAPI client initialization failed:", error);
                showMessage("Could not initialize Google services. Please check your API key and Client ID. Make sure the correct APIs are enabled in your Google Cloud project.");
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                authSpinner.classList.add('hidden');
                authButtons.classList.remove('hidden');
            }
        }

        connectBtn.addEventListener('click', handleGoogleConnect);
        disconnectBtn.addEventListener('click', handleGoogleDisconnect);

        function handleGoogleConnect() {
            if (!userId) {
                showMessage("Please wait, initializing user session.");
                return;
            }
            // FIX: Check for placeholder credentials before attempting to connect.
            if (GAPI_CLIENT_ID === '703348367691-fto8h5ngp2hm5qn5fkbfhtsh7re3pcub.apps.googleusercontent.com' || GAPI_API_KEY === 'AIzaSyCUhd0JfEzWlolkgAjPvfd6Fsyl60XtEY0') {
                showMessage('This app is not configured. Please replace the placeholder GAPI_CLIENT_ID and GAPI_API_KEY in the code with your own credentials from the Google Cloud Console.');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error("Google token response error:", resp);
                    showMessage("Authentication failed. Please check the console for details.");
                    return;
                }
                googleToken = resp;
                await saveTokenToFirestore(googleToken);
                await onGoogleLogin();
            };
            
            if (googleToken === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }
        
        async function handleGoogleDisconnect() {
            if (googleToken) {
                google.accounts.oauth2.revoke(googleToken.access_token, async () => {
                    googleToken = null;
                    gapi.client.setToken(null);
                    await deleteTokenFromFirestore();
                    showDisconnectedView();
                    showMessage('Successfully disconnected from Google.');
                });
            }
        }
        
        async function onGoogleLogin() {
            try {
                gapi.client.setToken(googleToken);
                const response = await gapi.client.drive.about.get({ fields: 'user' });
                const userName = response.result.user.displayName;
                showLoggedInView(userName);
                loadDriveFiles();
                loadCalendarEvents();
            } catch (error) {
                console.error("Error fetching user profile:", error);
                showMessage("Failed to fetch your Google profile information.");
            }
        }

        // --- Firestore Persistence ---

        async function saveTokenToFirestore(token) {
            if (!userId) return;
            try {
                const tokenDocRef = doc(db, `artifacts/${appId}/users/${userId}/googleToken/token`);
                await setDoc(tokenDocRef, token);
            } catch (error) {
                console.error("Error saving token to Firestore:", error);
            }
        }
        
        async function loadTokenFromFirestore() {
            if (!userId) return;
             authSpinner.classList.remove('hidden');
             authButtons.classList.add('hidden');
            try {
                const tokenDocRef = doc(db, `artifacts/${appId}/users/${userId}/googleToken/token`);
                const docSnap = await getDoc(tokenDocRef);
                if (docSnap.exists() && Object.keys(docSnap.data()).length > 0) {
                    googleToken = docSnap.data();
                     if (googleToken.expires_in <= 0) {
                        handleGoogleDisconnect();
                        return;
                    }
                    await onGoogleLogin();
                } else {
                    showAuthView();
                }
            } catch (error) {
                 console.error("Error loading token from Firestore:", error);
                 showAuthView();
            } finally {
                authSpinner.classList.add('hidden');
                authButtons.classList.remove('hidden');
            }
        }
        
        async function deleteTokenFromFirestore() {
             if (!userId) return;
             try {
                const tokenDocRef = doc(db, `artifacts/${appId}/users/${userId}/googleToken/token`);
                await setDoc(tokenDocRef, {}); // Clear the token data
            } catch (error) {
                console.error("Error deleting token from Firestore:", error);
            }
        }

        // --- Google Drive Logic ---
        saveNoteBtn.addEventListener('click', saveNoteToDrive);

        async function saveNoteToDrive() {
            const content = noteContentEl.value;
            if (!content.trim()) {
                showMessage("Note content cannot be empty.");
                return;
            }
            try {
                 const fileMetadata = {
                    'name': `Note-${new Date().toISOString()}.txt`,
                    'mimeType': 'text/plain',
                     parents: ['appDataFolder']
                };
                const file = new Blob([content], {type: 'text/plain'});
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                form.append('file', file);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + googleToken.access_token }),
                    body: form,
                });

                if(response.ok) {
                    noteContentEl.value = '';
                    showMessage("Note saved successfully!");
                    loadDriveFiles();
                } else {
                     throw new Error('Failed to save note.');
                }
            } catch (error) {
                console.error('Error saving note:', error);
                showMessage("Could not save the note. Please try again.");
            }
        }
        
        async function loadDriveFiles() {
            notesListEl.innerHTML = '';
            driveSpinner.classList.remove('hidden');
            try {
                const response = await gapi.client.drive.files.list({
                    spaces: 'appDataFolder',
                    fields: 'files(id, name, createdTime)',
                    pageSize: 10
                });
                const files = response.result.files || [];
                if (files.length > 0) {
                    files.forEach(file => {
                        const li = document.createElement('li');
                        li.className = "p-3 bg-gray-50 rounded-lg border flex justify-between items-center";
                        li.textContent = `${file.name} (Created: ${new Date(file.createdTime).toLocaleDateString()})`;
                        notesListEl.appendChild(li);
                    });
                } else {
                    notesListEl.innerHTML = '<p class="text-gray-500">No notes found.</p>';
                }
            } catch(error) {
                console.error("Error loading drive files:", error);
                notesListEl.innerHTML = '<p class="text-red-500">Could not load notes.</p>';
            } finally {
                 driveSpinner.classList.add('hidden');
            }
        }

        // --- Google Calendar Logic ---
        createEventBtn.addEventListener('click', createCalendarEvent);

        async function createCalendarEvent() {
            const title = eventTitleEl.value;
            const startTime = eventStartTimeEl.value;

            if (!title || !startTime) {
                showMessage("Event title and start time are required.");
                return;
            }

            try {
                const event = {
                    'summary': title,
                    'start': {
                        'dateTime': new Date(startTime).toISOString(),
                        'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone,
                    },
                    'end': {
                        'dateTime': new Date(new Date(startTime).getTime() + 60 * 60 * 1000).toISOString(),
                        'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone,
                    },
                };

                const request = await gapi.client.calendar.events.insert({
                    'calendarId': 'primary',
                    'resource': event,
                });
                
                eventTitleEl.value = '';
                eventStartTimeEl.value = '';
                showMessage("Event created successfully!");
                loadCalendarEvents();
            } catch (error) {
                 console.error("Error creating event:", error);
                 showMessage("Failed to create the event.");
            }
        }

        async function loadCalendarEvents() {
            eventsListEl.innerHTML = '';
            calendarSpinner.classList.remove('hidden');
            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary',
                    'timeMin': (new Date()).toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'maxResults': 10,
                    'orderBy': 'startTime'
                });
                const events = response.result.items || [];
                 if (events.length > 0) {
                    events.forEach(event => {
                        const start = event.start.dateTime || event.start.date;
                        const li = document.createElement('li');
                        li.className = "p-3 bg-gray-50 rounded-lg border";
                        li.innerHTML = `<strong>${event.summary}</strong> - ${new Date(start).toLocaleString()}`;
                        eventsListEl.appendChild(li);
                    });
                } else {
                    eventsListEl.innerHTML = '<p class="text-gray-500">No upcoming events found.</p>';
                }
            } catch(error) {
                 console.error("Error loading calendar events:", error);
                 eventsListEl.innerHTML = '<p class="text-red-500">Could not load events.</p>';
            } finally {
                calendarSpinner.classList.add('hidden');
            }
        }


        // --- App Entry Point ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            loadGoogleAPIs();
        });
    </script>

</body>
</html>

